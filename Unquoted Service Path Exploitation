title: Unquoted Service Path Exploitation via Malicious Binary Execution

description: Detects execution of binaries from intermediate directories of unquoted
  service paths, consistent with Unquoted Service Path privilege escalation
  as demonstrated in public exploitation walkthroughs and PowerSploit tooling.

references:
  - https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae
  - https://research.splunk.com/endpoint/cbef820c-e1ff-407f-887f-0a9240a2d477/
tags:
  - attack.privilege_escalation
  - attack.t1574.009
  - attack.execution
  - windows

logsource:
  category: process_creation
  product: windows

detection:
  unquoted_path_execution:
    Image|re:
      - '^C:\\[^\\ ]+\.exe$'
      - '^C:\\Program Files\\[^\\ ]+\.exe$'
      - '^C:\\Program Files \(x86\)\\[^\\ ]+\.exe$'
#the above regex will match paths such as [C:\Program.exe] and will ignore [C:\Program Files\Google\Chrome\Application\chrome.exe]

  service_execution:
    ParentImage|endswith:
      - '\services.exe'
      - '\svchost.exe'
    User: 'NT AUTHORITY\SYSTEM'

  powersploit_optional:
    ParentImage|endswith: '\powershell.exe'
    CommandLine|contains|all:
      - 'PowerUp'
      - 'Write-ServiceBinary'

  filter_legitimate:
    Image|contains:
      - '\Windows\System32\'
      - '\Windows\SysWOW64\'

  condition: unquoted_path_execution and (service_execution or powersploit_optional) and not filter_legitimate

falsepositives:
  - Legacy third-party services installed incorrectly
  - Custom enterprise software with bad service paths

level: critical
